# CLAUDE.md

Documenta√ß√£o t√©cnica e guia para desenvolvimento do Sistema Web Alencar Frutas.

## ‚öôÔ∏è Configura√ß√£o
- **Idioma:** Portugu√™s do Brasil (PT-BR)
- **Ambiente:** Windows 11 + IDE Cursor
- **Terminal:** `claude` (alias configurado)
- **MCP Render:** Configurado para deploy e gerenciamento de servi√ßos

## üìã Sistema Web Alencar Frutas

Sistema completo de gest√£o agr√≠cola especializado em comercializa√ß√£o de frutas, com funcionalidades espec√≠ficas para controle de √°reas pr√≥prias e de fornecedores, pedidos, clientes e gest√£o financeira.

### üèóÔ∏è Arquitetura
```
SistemaWebAlencarFrutas/
‚îú‚îÄ‚îÄ frontend/          # React 18.2.0 (porta 3002)
‚îÇ   ‚îú‚îÄ‚îÄ src/pages/     # P√°ginas da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ src/components/ # Componentes reutiliz√°veis
‚îÇ   ‚îî‚îÄ‚îÄ src/utils/     # Utilit√°rios e helpers
‚îú‚îÄ‚îÄ backend/           # NestJS 11.0.1 API
‚îÇ   ‚îú‚îÄ‚îÄ src/auth/      # Sistema de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ src/prisma/    # Configura√ß√£o do Prisma ORM
‚îÇ   ‚îî‚îÄ‚îÄ src/[m√≥dulos]/ # M√≥dulos de neg√≥cio
‚îî‚îÄ‚îÄ CLAUDE.md          # Este arquivo
```

### üõ†Ô∏è Stack Tecnol√≥gica

**Frontend:** React 18.2.0, Ant Design 5.22.4, Material-UI 5.16.14, React Router DOM, Axios, Socket.io Client

**Backend:** NestJS 11.0.1, Prisma 6.12.0, JWT/Passport, Socket.io, Swagger

**Database:** PostgreSQL com Prisma schema

**Comunica√ß√£o:** REST APIs + WebSocket para notifica√ß√µes em tempo real

### üé® Sistema de Cores
- Cor principal: Verde (#059669)
- Header tabelas: Verde (#059669)
- Tema global configurado em `frontend/src/theme.js`

## üöÄ Comandos de Desenvolvimento

**Frontend (porta 3002):**
- `cd frontend && npm start` - Servidor de desenvolvimento
- `npm run build` - Build de produ√ß√£o
- ‚ö†Ô∏è **IMPORTANTE:** N√£o executar builds autom√°ticos - o usu√°rio testa manualmente

**Backend:**
- `cd backend && npm run start:dev` - API com watch mode
- `npm run build` - Build de produ√ß√£o (verificar erros)
- `npm run lint` - ESLint check

‚ö†Ô∏è **IMPORTANTE:** NUNCA executar comandos `npm start` ou `npm run start:dev` automaticamente. O usu√°rio gerencia a execu√ß√£o dos servi√ßos.

**Database (Prisma):**
- `npx prisma generate` - Gerar cliente Prisma
- `npx prisma studio` - Interface visual do banco
- `npx prisma migrate dev` - Aplicar migra√ß√µes

**Deploy & Infraestrutura:**
- **MCP Render:** `claude mcp list` - Verificar status da conex√£o
- **API Key:** Configurada para gerenciamento de servi√ßos no Render
- **Deploy:** Acesso direto aos servi√ßos atrav√©s do Claude Code

---

## üè¢ L√≥gica de Neg√≥cio - AlencarFrutas

### üìä Dom√≠nios do Sistema

**üå± Gest√£o Agr√≠cola:**
- Culturas (perenes/tempor√°rias)
- √Åreas pr√≥prias (COLONO, TECNICO, EMPRESARIAL, ADJACENTE)
- Fornecedores com √°reas vinculadas
- Controle de produ√ß√£o (fitas de banana com cores)

**üçé Comercializa√ß√£o:**
- Frutas por categorias (CITRICOS, TROPICAIS, TEMPERADAS)
- Clientes com dados fiscais
- Pedidos com fluxo sequencial de 10 status
- M√∫ltiplos pagamentos (PIX, BOLETO, TRANSFER√äNCIA)

**‚öôÔ∏è Configura√ß√µes:**
- Dados da empresa e contas banc√°rias
- Credenciais de APIs e comunica√ß√£o (Email/WhatsApp)
- Notifica√ß√µes em tempo real

### üîÑ Fluxo de Pedidos (10 Status Sequenciais)

**Ciclo de Vida do Pedido:**
1. **PEDIDO_CRIADO** ‚Üí dados b√°sicos (cliente, frutas, quantidades previstas)
2. **AGUARDANDO_COLHEITA** ‚Üí aguarda data de colheita
3. **COLHEITA_REALIZADA** ‚Üí quantidades reais + √°reas + fitas + frete
4. **AGUARDANDO_PRECIFICACAO** ‚Üí aguarda defini√ß√£o de pre√ßos
5. **PRECIFICACAO_REALIZADA** ‚Üí valores + frete + ICMS - descontos
6. **AGUARDANDO_PAGAMENTO** ‚Üí aguarda pagamento do cliente
7. **PAGAMENTO_PARCIAL** ‚Üí pagamento parcial recebido
8. **PAGAMENTO_REALIZADO** ‚Üí valor total recebido
9. **PEDIDO_FINALIZADO** ‚Üí processo completo (estado final)
10. **CANCELADO** ‚Üí cancelado em qualquer fase (estado final)

**Caracter√≠sticas:**
- Transi√ß√µes autom√°ticas entre status
- Estados finais n√£o edit√°veis (FINALIZADO/CANCELADO)
- Sistema de m√∫ltiplas √°reas e fitas por fruta
- Dupla unidade de medida com precifica√ß√£o flex√≠vel
- M√∫ltiplos pagamentos por pedido

### üîß Regras de Transi√ß√£o

**Estados Finais (N√£o Edit√°veis):**
- PEDIDO_FINALIZADO e CANCELADO

**Transi√ß√µes Autom√°ticas:**
- Cria√ß√£o ‚Üí AGUARDANDO_COLHEITA (autom√°tico)
- Colheita ‚Üí COLHEITA_REALIZADA ‚Üí AGUARDANDO_PRECIFICACAO (autom√°tico)
- Precifica√ß√£o ‚Üí PRECIFICACAO_REALIZADA ‚Üí AGUARDANDO_PAGAMENTO (autom√°tico)
- Pagamentos baseados em valor: PARCIAL (< total) ou REALIZADO (>= total)

**Sistema de Tabs com Controle de Acesso:**
- Aba 1 (Dados B√°sicos): sempre edit√°vel (exceto finalizados)
- Aba 2 (Colheita): ap√≥s colheita realizada
- Aba 3 (Precifica√ß√£o): ap√≥s precifica√ß√£o realizada
- Aba 4 (Pagamentos): ap√≥s pagamentos iniciados

### üåê Estrutura da API

**Autentica√ß√£o:** `/auth/login`, `/auth/profile`

**M√≥dulos Principais:**
- `/api/pedidos` - Sistema completo de pedidos + dashboard
- `/api/frutas`, `/api/clientes`, `/api/areas-agricolas`  
- `/api/fornecedores`, `/api/areas-fornecedores`
- `/fitas-banana`, `/controle-banana` - Sistema de produ√ß√£o
- `/config`, `/notificacoes` - Configura√ß√µes e notifica√ß√µes

### üñ•Ô∏è P√°ginas do Frontend

- **Dashboard** (`/`) - Vis√£o geral
- **Pedidos** (`/pedidos`) - Gest√£o completa de pedidos
- **√Åreas Agr√≠colas** (`/areas-agricolas`) - Gest√£o de √°reas pr√≥prias  
- **Frutas, Clientes, Fornecedores** - CRUDs b√°sicos
- **Produ√ß√£o > Banana** (`/producao/banana`) - Controle de fitas
- **Configura√ß√µes** (`/configuracoes`) - Setup do sistema

### üíæ Caracter√≠sticas T√©cnicas

**Relacionamentos Complexos:**
- Pedidos N:N Frutas (tabela `FrutasPedidos`)
- √Åreas exclusivas: pr√≥prias OU fornecedores
- M√∫ltiplos pagamentos por pedido
- Dupla unidade de medida (ex: KG + CX)

**Espec√≠fico do Agroneg√≥cio:**
- Fitas de colheita com cores hexadecimais
- Controle log√≠stico (pesagem, placas)
- Contas destino (ALENCAR, FRANCIALDA, GAVETA)
- Thread-safety na gera√ß√£o de n√∫meros

### üéØ Status de Implementa√ß√£o
‚úÖ **Completos:** Schema Prisma, Backend NestJS, Frontend React, Auth JWT, WebSocket
‚ö†Ô∏è **Em desenvolvimento:** Ajustes nas regras de neg√≥cio

---

## üõí Sistema de Pedidos - N√∫cleo do Sistema

Arquitetura complexa com 10 status sequenciais, relacionamentos N:N, dupla unidade de medida, m√∫ltiplas √°reas/fitas por fruta, m√∫ltiplos pagamentos e thread-safety.

### üóÑÔ∏è Modelos Principais do Schema

**Pedido:** numeroPedido √∫nico, clienteId, datas, valores financeiros consolidados, status sequencial

**FrutasPedidos:** relacionamento N:N com dupla unidade de medida, precifica√ß√£o flex√≠vel, m√∫ltiplas √°reas e fitas

**FrutasPedidosAreas:** √°reas exclusivas (pr√≥prias OU fornecedores) por fruta

**FrutasPedidosFitas:** m√∫ltiplas fitas com cores por fruta (espec√≠fico banana)

**PagamentosPedidos:** m√∫ltiplos pagamentos com diferentes m√©todos e contas destino

### üñ•Ô∏è Componentes Frontend por Fase

**1. NovoPedidoModal:** Cliente + m√∫ltiplas frutas + dupla unidade + valida√ß√µes

**2. ColheitaModal:** Quantidades reais + √°reas m√∫ltiplas + fitas + frete + valida√ß√µes exclusivas

**3. PrecificacaoModal:** Valores unit√°rios + unidade flex√≠vel + c√°lculos autom√°ticos + resumo financeiro

**4. PagamentoModal:** M√∫ltiplos pagamentos + m√©todos + contas destino + status autom√°tico

**5. EditarPedidoDialog:** 4 tabs com controle de acesso por status + valida√ß√µes din√¢micas

### üîß Backend - Servi√ßos Principais

**PedidosService:**
- `gerarNumeroPedido()` - Thread-safe, formato PED-YYYY-0001
- `gerenciarAreasEFitas()` - CRUD granular de relacionamentos
- `calcularValoresConsolidados()` - Soma frutas + frete + impostos - descontos
- `atualizarStatusPagamento()` - Status autom√°tico baseado em valores

**APIs Principais:**
- CRUD pedidos `/api/pedidos` + dashboard
- Opera√ß√µes por fase: colheita, precifica√ß√£o, pagamentos

### üéØ Inova√ß√µes T√©cnicas

1. **Thread-Safety:** Gera√ß√£o √∫nica de n√∫meros por busca de m√°ximo + incremento
2. **M√∫ltiplas √Åreas:** Exclusividade (pr√≥prias OU fornecedores) + valida√ß√µes
3. **Dupla Unidade:** KG+CX com precifica√ß√£o flex√≠vel em qualquer unidade
4. **Fitas Coloridas:** Controle visual de produ√ß√£o com cores hex
5. **C√°lculos Autom√°ticos:** Valores e status recalculados em tempo real

---

## üîç Diretrizes de Desenvolvimento

### ‚ö†Ô∏è Verifica√ß√µes Obrigat√≥rias
**Endpoints:** Consultar controllers `.controller.ts` antes de usar (alguns t√™m `/api/`, outros n√£o)

**Propriedades:** Verificar DTOs/schemas reais (ex: `numeroPedido`, n√£o `numero`)

**Relacionamentos:** Consultar `schema.prisma` (ex: `frutasPedidos`, n√£o `frutas`)

**Models:** Verificar nomes exatos (ex: `Usuario` n√£o `User`, enum `NivelUsuario.ADMINISTRADOR`)

### üõ†Ô∏è Ferramentas Padronizadas
**Notifica√ß√µes:** `showNotification(tipo, t√≠tulo, mensagem)` de `notificationConfig.js`

**HTTP:** `axiosInstance` (nunca axios direto) - JWT autom√°tico + baseURL

**Pagina√ß√£o:** `currentPage`, `pageSize=20`, `total` com Pagination padr√£o

**Inputs:** `MaskedDecimalInput`, `HectaresInput`, `FormButton` de `/common/`

---

## üîß Principais Implementa√ß√µes

### ‚úÖ Funcionalidades Completas
- **Dashboard de Pedidos:** Se√ß√µes por status + cards de estat√≠sticas + modais funcionais
- **Sistema de Produ√ß√£o:** Google Maps + controle de fitas com cores + contagem correta
- **Thread-Safety:** Gera√ß√£o √∫nica de n√∫meros de pedido por busca de m√°ximo
- **Valida√ß√µes:** Unidades de medida + √°reas exclusivas + pagamentos autom√°ticos
- **UI Padronizada:** √çcones consistentes + loading otimizado + componentes reutiliz√°veis

---

## üçå Sistema de Controle de Banana

M√≥dulo espec√≠fico para produ√ß√£o de bananas com controle visual por fitas coloridas.

**Tabelas:** `fitas_banana`, `controle_banana`, `historico_fitas` com auditoria completa

**APIs:** `/fitas-banana`, `/controle-banana`, `/historico-fitas` (CRUD + dashboard)

**Frontend:** P√°gina com Google Maps (70%) + listagem (30%) + modais + seletor de cores

---

## üé® Padr√µes de Interface

### üîò Componentes de Bot√µes
**PrimaryButton:** P√°ginas principais (40px altura)
**FormButton:** Formul√°rios e modais (48px altura, alinhado com inputs)
**Button padr√£o:** Footers de modais

### ü™ü Estrutura de Modais
- Header verde (#059669) com √≠cone e t√≠tulo
- Cards internos com headers verdes para agrupamento
- Labels com √≠cones coloridos
- Footer com bot√µes de a√ß√£o alinhados √† direita

### üìã Padr√µes de UI
**Cores:** Verde prim√°rio (#059669), headers de tabela padronizados
**√çcones:** Material-UI preferencial, consist√™ncia visual
**Loading:** States otimizados, sem "flickering"
**Notifica√ß√µes:** Sistema centralizado com tipos (success/error/warning/info)

### üîß Componentes de Input
**MaskedDecimalInput:** Valores decimais com padr√£o brasileiro (1.234,56)
**HectaresInput:** Espec√≠fico para √°reas com sufixo "ha" autom√°tico  
**FormButton:** Bot√µes em formul√°rios (48px altura)
**Importa√ß√£o:** `from "../common/inputs"` ou `from "../common/buttons"`

---

## üéØ Implementa√ß√µes Recentes

### üçå Nova L√≥gica de Vincula√ß√£o de Fitas (2024-12-15)

**Mudan√ßa Principal:** Sistema agora permite sele√ß√£o de **lotes individuais** em vez de agrega√ß√£o autom√°tica por √°rea.

**Antes:**
- Fitas eram agrupadas por cor/√°rea 
- Sistema subtra√≠a automaticamente do lote mais antigo
- Usu√°rio n√£o tinha controle sobre qual lote espec√≠fico usar

**Depois:**
- **Sele√ß√£o por lote espec√≠fico** da tabela `controle_banana`
- Usu√°rio v√™ todos os lotes dispon√≠veis com:
  - Data de marca√ß√£o ("Marcado: DD/MM/YY") 
  - Tempo decorrido (dias ou semanas arredondadas para cima)
  - Quantidade dispon√≠vel no lote
  - Layout com cores da fita para melhor identifica√ß√£o

**Arquivos Modificados:**
- `frontend/src/components/pedidos/VincularFitasModal.js` - Nova interface por lotes
- Backend mantido (endpoint `/controle-banana/fitas-com-areas` j√° retornava lotes individuais)

**Vantagens:**
‚úÖ **Controle preciso** - usu√°rio escolhe exatamente qual lote usar
‚úÖ **Transpar√™ncia** - mostra data de colheita e idade de cada lote
‚úÖ **Flexibilidade** - n√£o for√ßa ordem autom√°tica de consumo
‚úÖ **Rastreabilidade** - mant√©m hist√≥rico exato de qual lote foi usado
‚úÖ **UI melhorada** - cards compactos com cores das fitas

**Compatibilidade:** Mant√©m integra√ß√£o com `ColheitaModal.js` e `ColheitaTab.js` sem altera√ß√µes.

---

> **Sistema especializado em gest√£o agr√≠cola para comercializa√ß√£o de frutas com foco em pedidos sequenciais, m√∫ltiplas √°reas de produ√ß√£o e controle visual por fitas coloridas.**
- sempre atualize @README.md quando finalizar altera√ß√µes que achar que a documenta√ß√£o precisa ser atualizada