// ========================================
// MODELO PROPOSTO: CONTROLE DE PAGAMENTOS API BB
// ========================================
// Este arquivo contém a proposta de modelo para controle de pagamentos
// via API do Banco do Brasil. Será integrado ao schema.prisma principal.

// ========================================
// TABELA DE CONTROLE DE SEQUÊNCIA
// ========================================
// Controla o número sequencial de requisições (iniciando em 1)
model SequenciaNumeroRequisicao {
  id                    Int      @id @default(autoincrement())
  ultimoNumero          Int      @default(0) // Último número usado
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("sequencia_numero_requisicao")
}

// ========================================
// TABELA PRINCIPAL: LOTE DE PAGAMENTOS
// ========================================
model PagamentoApiLote {
  id                    Int                    @id @default(autoincrement())
  
  // Identificação do Lote na API BB
  numeroRequisicao      Int                    @unique // Número sequencial único (1, 2, 3...)
  numeroContrato        Int                    // Convênio PGT (ex: 731030)
  tipoPagamento         Int                    // 126=Fornecedores, 128=Diversos
  
  // Tipo de pagamento API (PIX, BOLETO, GUIA)
  tipoPagamentoApi      TipoPagamentoApi       @default(PIX) // PIX, BOLETO, GUIA
  
  // Conta utilizada
  contaCorrenteId       Int
  contaCorrente         ContaCorrente          @relation(fields: [contaCorrenteId], references: [id])
  
  // Dados da requisição enviada (payload completo)
  payloadEnviado        Json                   // Payload completo enviado ao BB
  
  // Dados da resposta recebida (resposta inicial)
  payloadResposta       Json?                  // Resposta completa do BB
  estadoRequisicao      Int?                   // Estado retornado pelo BB (1=enviado, etc)
  quantidadeEnviada     Int                    // Quantidade de itens enviados (transferências/lançamentos)
  valorTotalEnviado     Decimal                @db.Decimal(15, 2)
  quantidadeValida      Int?                   // Quantidade aceita pelo BB
  valorTotalValido      Decimal?               @db.Decimal(15, 2)
  
  // Status do processamento interno
  status                StatusPagamentoLote    @default(PENDENTE)
  processadoComSucesso  Boolean                @default(false)
  dataProcessamento     DateTime?
  
  // Controle de atualização de status (via consulta ou webhook)
  ultimaConsultaStatus  DateTime?              // Última vez que consultamos o status no BB
  ultimaAtualizacaoWebhook DateTime?           // Última atualização recebida via webhook
  estadoRequisicaoAtual Int?                   // Estado atual (pode mudar após consulta/webhook)
  payloadRespostaAtual  Json?                  // Resposta mais recente (após consulta/webhook)
  
  // Auditoria
  observacoes           String?
  erroProcessamento     String?                @db.Text
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  // Relacionamentos com itens pagos
  itensPagamento        PagamentoApiItem[]
  
  @@index([numeroRequisicao])
  @@index([contaCorrenteId])
  @@index([tipoPagamentoApi])
  @@index([status])
  @@index([createdAt])
  @@index([estadoRequisicaoAtual])
  @@map("pagamento_api_lote")
}

enum TipoPagamentoApi {
  PIX                   // Transferências PIX (limite: 320 registros)
  BOLETO                // Pagamento de boletos (limite: 150 registros)
  GUIA                  // Pagamento de guias com código de barras (futuro)
}

enum StatusPagamentoLote {
  PENDENTE              // Lote criado, aguardando envio
  ENVIADO               // Enviado ao BB, aguardando resposta inicial
  PROCESSANDO           // BB está processando
  CONCLUIDO             // Processado com sucesso (todos os itens aceitos)
  PARCIAL               // Alguns itens foram aceitos, outros rejeitados
  REJEITADO             // Lote rejeitado pelo BB (todos os itens rejeitados)
  ERRO                  // Erro no processamento
}

// Mapeamento dos estados da requisição do BB (estadoRequisicao):
// 1 - Requisição com todos os lançamentos com dados consistentes
// 2 - Requisição com ao menos um dos lançamentos com dados inconsistentes
// 3 - Requisição com todos os lançamentos com dados inconsistentes
// 4 - Requisição pendente de ação pelo Conveniado - falta autorizar o pagamento
// 5 - Requisição em processamento pelo Banco
// 6 - Requisição Processada
// 7 - Requisição Rejeitada
// 8 - Preparando remessa não liberada
// 9 - Requisição liberada via API
// 10 - Preparando remessa liberada

// ========================================
// TABELA DE ITENS: CADA PAGAMENTO DO LOTE
// ========================================
model PagamentoApiItem {
  id                    Int                    @id @default(autoincrement())
  
  // Relacionamento com o lote
  loteId                Int
  lote                  PagamentoApiLote       @relation(fields: [loteId], references: [id], onDelete: Cascade)
  
  // Identificação do item no lote (índice na listaTransferencias/lancamentos)
  indiceLote            Int                    // Posição na lista (0, 1, 2...)
  
  // Dados do item enviado ao BB (campos comuns)
  valorEnviado          Decimal                @db.Decimal(15, 2)
  dataPagamentoEnviada  String                 // Data no formato ddmmaaaa
  descricaoEnviada      String?
  payloadItemEnviado    Json                   // Dados completos do item enviado (preserva tudo)
  
  // Dados específicos de PIX (quando tipoPagamentoApi = PIX)
  descricaoInstantaneoEnviada String?          // descricaoPagamentoInstantaneo (apenas PIX)
  chavePixEnviada       String?                // Chave PIX (apenas PIX)
  tipoChavePixEnviado   Int?                   // 1=Telefone, 2=Email, 3=CPF/CNPJ, 4=Chave Aleatória (apenas PIX)
  identificadorPagamento String?               // Identificador PIX retornado pelo BB (ex: 96494633731030000)
  indicadorMovimentoAceito String?             // "S" ou "N" - PIX (resposta inicial)
  indicadorMovimentoAceitoAtual String?        // "S" ou "N" - PIX (status atual)
  
  // Dados específicos de BOLETO (quando tipoPagamentoApi = BOLETO)
  numeroCodigoBarras    String?                // Código de barras do boleto (44 dígitos) - apenas BOLETO
  codigoIdentificadorPagamento String?         // Identificador boleto retornado pelo BB - apenas BOLETO
  indicadorAceite       String?                // "S" ou "N" - BOLETO (resposta inicial)
  indicadorAceiteAtual  String?                // "S" ou "N" - BOLETO (status atual)
  valorNominal          Decimal?               @db.Decimal(15, 2) // Valor original do boleto - apenas BOLETO
  valorDesconto         Decimal?               @db.Decimal(15, 2) // Valor do desconto - apenas BOLETO
  valorMoraMulta        Decimal?               @db.Decimal(15, 2) // Valor de mora/multa - apenas BOLETO
  
  // Dados específicos de GUIA (quando tipoPagamentoApi = GUIA)
  codigoPagamento       String?                // Identificador GUIA retornado pelo BB (ex: 97310301234560001) - apenas GUIA
  codigoBarrasGuia      String?                // Código de barras da guia (44 dígitos, sem dígitos verificadores) - apenas GUIA
  nomeBeneficiario      String?                // Nome do beneficiário/convenente - apenas GUIA
  indicadorAceiteGuia   String?                // "S" ou "N" - GUIA (resposta inicial)
  indicadorAceiteGuiaAtual String?             // "S" ou "N" - GUIA (status atual)
  
  // Dados da resposta do BB (resposta inicial) - campos comuns
  erros                 Json?                  // Array de erros retornados pelo BB
  payloadItemResposta   Json?                  // Resposta completa do item (resposta inicial)
  
  // Dados atualizados (via consulta ou webhook) - campos comuns
  payloadItemRespostaAtual Json?               // Resposta mais recente
  ultimaAtualizacaoStatus DateTime?            // Última atualização de status
  
  // Dados da consulta individual
  // Para PIX: GET /pix/:identificadorPagamento
  // Para BOLETO: GET /boletos/:codigoIdentificadorPagamento
  // Para GUIA: GET /guias-codigo-barras/:codigoPagamento
  estadoPagamentoIndividual String?            // Estado do pagamento individual: Consistente, Inconsistente, Pendente, Agendado, Rejeitado, Cancelado, Devolvido, Bloqueado, Aguardando débito, Debitado, Vencido, Pago
  payloadConsultaIndividual Json?              // Resposta completa da consulta individual
  ultimaConsultaIndividual DateTime?           // Última consulta individual realizada
  listaDevolucao        Json?                  // Array de devoluções (BOLETO e GUIA) - contém codigoMotivo, dataDevolucao (apenas BOLETO), valorDevolucao (apenas BOLETO)
  
  // Relacionamento polimórfico com o registro pago
  // Usando campos nullable para suportar diferentes tipos
  turmaColheitaCustoId  Int?                   // Se for pagamento de turma de colheita
  fornecedorPagamentoId Int?                   // Se for pagamento de fornecedor
  funcionarioPagamentoId Int?                  // Se for pagamento de funcionário (futuro)
  
  // Relacionamentos específicos
  turmaColheitaCusto    TurmaColheitaPedidoCusto? @relation(fields: [turmaColheitaCustoId], references: [id], onDelete: SetNull)
  fornecedorPagamento   FornecedorPagamento?   @relation(fields: [fornecedorPagamentoId], references: [id], onDelete: SetNull)
  // funcionarioPagamento  FuncionarioPagamento? @relation(fields: [funcionarioPagamentoId], references: [id], onDelete: SetNull)
  
  // Status do item
  status                StatusPagamentoItem    @default(PENDENTE)
  processadoComSucesso  Boolean                @default(false)
  
  // Auditoria
  observacoes           String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  // Constraints: garantir que apenas um tipo de relacionamento seja preenchido
  @@index([loteId])
  @@index([loteId, indiceLote]) // Para garantir ordem no lote
  @@index([turmaColheitaCustoId])
  @@index([fornecedorPagamentoId])
  @@index([identificadorPagamento]) // Para PIX
  @@index([codigoIdentificadorPagamento]) // Para BOLETO
  @@index([codigoPagamento]) // Para GUIA
  @@index([status])
  @@map("pagamento_api_item")
}

enum StatusPagamentoItem {
  PENDENTE              // Item criado, aguardando envio
  ENVIADO               // Enviado ao BB
  ACEITO                // Aceito pelo BB (indicadorMovimentoAceito = "S")
  REJEITADO             // Rejeitado pelo BB (indicadorMovimentoAceito = "N")
  PROCESSADO            // Processado internamente (marcado como pago na tabela de origem)
  ERRO                  // Erro no processamento
}

// Estados do pagamento individual retornados pelo BB:
// Para PIX: GET /pix/:identificadorPagamento
// Para BOLETO: GET /boletos/:codigoIdentificadorPagamento
// 
// Estados possíveis (comuns para PIX e BOLETO):
// - Consistente: Dados recebidos sem ocorrências quanto ao formato. Aguardando validação.
// - Inconsistente: Dados recebidos com ocorrências quanto ao formato. Será alterado para rejeitado.
// - Pendente: Falta autorização/liberação para o débito.
// - Agendado: Pagamento aguardando a data para efetivação do crédito.
// - Rejeitado: Dados não passaram nas validações físicas e/ou lógicas.
// - Cancelado: Pagamento cancelado pelo Cliente Conveniado antes da data do crédito.
// - Devolvido: Pagamento efetuado e posteriormente recusado pelo recebedor.
// - Bloqueado: Débito não efetivado por ocorrência no convênio, inconsistência de data/float ou falta de saldo.
// - Aguardando débito: Débito não efetivado, em processamento ou em verificação de saldo.
// - Debitado: Pagamento debitado na conta do pagador e pendente de crédito ao favorecido.
// - Vencido: Pagamento não efetuado na data indicada por falta de saldo ou falta de autorização.
// - Pago: Pagamento efetuado.

// ========================================
// ATUALIZAÇÕES NAS TABELAS EXISTENTES
// ========================================

// Adicionar em TurmaColheitaPedidoCusto:
// itensPagamentoApi     PagamentoApiItem[]

// Adicionar em FornecedorPagamento:
// itensPagamentoApi     PagamentoApiItem[]

// ========================================
// OBSERVAÇÕES IMPORTANTES
// ========================================
// 1. numeroRequisicao é sequencial e único, controlado pela tabela SequenciaNumeroRequisicao
//    - Range permitido pelo BB: 1 a 9999999
//    - Não precisa ser sequencial segundo BB, mas escolhemos sequencial para facilitar controle
// 2. O modelo suporta lotes com 1 ou muitos itens (flexível)
//    - Limite PIX: máximo de 320 registros por lote
//    - Limite BOLETO: máximo de 150 registros por lote
//    - Limite GUIA: máximo de 200 registros por lote
// 3. tipoPagamentoApi diferencia o tipo de pagamento (PIX, BOLETO, GUIA)
//    - Permite que o mesmo modelo suporte diferentes tipos de pagamento
//    - Campos específicos são nullable e preenchidos conforme o tipo
// 4. Preparado para expansão: campos nullable para fornecedores e funcionários
// 5. Status pode ser atualizado via:
//    - Consulta de lote PIX: GET /lotes-transferencias-pix/:numeroRequisicao/solicitacao
//    - Consulta de lote BOLETO: GET /lotes-boletos/:numeroRequisicao/solicitacao
//    - Consulta de lote GUIA: GET /lotes-guias-codigo-barras/:numeroRequisicao/solicitacao
//    - Consulta individual PIX: GET /pix/:identificadorPagamento
//    - Consulta individual BOLETO: GET /boletos/:codigoIdentificadorPagamento
//    - Consulta individual GUIA: GET /guias-codigo-barras/:codigoPagamento
//    - Webhook: POST (futuro)
// 6. Payload completo (JSON) permite auditoria e reprocessamento
// 7. Identificadores:
//    - PIX: identificadorPagamento (usado para GET /pix/:id)
//    - BOLETO: codigoIdentificadorPagamento (usado para GET /boletos/:id)
//    - GUIA: codigoPagamento (usado para GET /guias-codigo-barras/:id)
// 8. Indicadores de aceite:
//    - PIX: indicadorMovimentoAceito ("S" ou "N")
//    - BOLETO: indicadorAceite ("S" ou "N")
//    - GUIA: indicadorAceiteGuia ("S" ou "N")
// 9. ATENÇÃO: Guias permitem pagamento repetido da mesma guia. Caso não receba confirmação,
//    NÃO REENVIE. Utilize a consulta de lote para verificar se a solicitação foi recebida.

